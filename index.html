<!DOCTYPE html>
<html>
    <head>
        <title>Firecyclist JS</title>
        <meta charset="UTF-8" />
        <style>
            html, body {
                margin: 0;
                padding: 0;
                user-select: none;
                cursor: default;
                background: black;
            }
            #Main, canvas {
                background: white;
                position: fixed;
                top: 0;
                left: 0;
            }
        </style>
    </head>
    <body data-role="page">
        <div id="Main">
            <canvas id="canvas" width="288" height="512"></canvas>
        </div>
        <div id="touch" style="color: white; position: absolute; top: 515px; left: 0; width: 400px; height: 6em; overflow-y: scroll;"></div>
        <script src="jquery-1.11.2.min.js"></script>
        <!--script src="jquery.mobile-1.4.5.min.js"></script-->
        <script src="firecyclist.js"></script>
        <script>
            (function () {
                var htmlModule = document.getElementById('canvas'),
                    htmlBody = document.querySelector("body"),
                    docEvent = function (event, handler) { // This is here for removing jQuery in the future.
                        /*if (Array.isArray(event)) {
                            event.forEach(function (e) {
                                docEvent(e, handler);
                            });
                        } else {
                            document.addEventListener(event, handler, false);
                        }*/
                        if (Array.isArray(event)) {
                            jQuery(document).on(event.join(" "), handler);
                        } else {
                            jQuery(document).on(event, handler);
                        }
                    },
                    windowDims = {
                        "width": window.innerWidth || document.documentElement.clientWidth, // The defaulting expression (.documentElement....) is for IE
                        "height": window.innerHeight || document.documentElement.clientHeight
                    },
                    pageScaleFactor = 1,
                    moduleOffsetX = 0,
                    resize = function () { // This zooms the page so that the Firecyclist rectangle (initially always (576/2) by (1024/2) in dimensions), fits to the page.
                        var scaleX = windowDims.width / (576 / 2),
                            scaleY = windowDims.height / (1024 / 2),
                            unfitAxis;
                        pageScaleFactor = Math.min(scaleX, scaleY);
                        unfitAxis = pageScaleFactor === scaleX ? "y" : "x";
                        htmlBody.setAttribute("style", [ // Using htmlBody.style[property] did not work for the browser-specific props.
                            "-moz-transform-origin: 0 0",
                            "-moz-transform: scale(" + pageScaleFactor + ")",
                            "-webkit-transform-origin: 0 0",
                            "-webkit-transform: scale(" + pageScaleFactor + ")",
                            "-ms-transform-origin: 0 0",
                            "-ms-transform: scale(" + pageScaleFactor + ")"
                        ].join("; "));
                        if (unfitAxis === "x") {
                            moduleOffsetX = ((windowDims.width - (576 / 2) * pageScaleFactor) / 2) / pageScaleFactor; // The last division, by pageScaleFactor, is there because the zoom done above will automatically scale this whole expression/offest by pageScaleFactor, so the division undoes that.
                            htmlModule.setAttribute("style", "position: fixed; left: " + Math.floor(moduleOffsetX) + "px;");
                        }
                    };
                //resize();
                (function () {
                    var touchesCount = 0,
                        calcPos = function (event) {
                            var usingOriginalEvent = typeof event.clientX === "number";
                            return {
                                "x": (typeof event.clientX === "number" ? event.clientX : event.originalEvent.changedTouches[0].clientX) / pageScaleFactor - moduleOffsetX,
                                "y": (typeof event.clientY === "number" ? event.clientY : event.originalEvent.changedTouches[0].clientY) / pageScaleFactor,
                                "usingOriginalEvent": usingOriginalEvent
                            };
                        },
                        updateCurTouch = function () {
                            var fmted = "(" + curTouch.x0 + ", " + curTouch.y0 + ") -> (" + curTouch.x + ", " + curTouch.y + ")"; //") at \n  " + curTouch.t0/
                            if (curTouch.usingOriginalEvent) {
                                fmted += " using originalEvent";
                            } else {
                                fmted += " NOT using originalEvent";
                            }
                            jQuery("#touch").prepend("<p>" + fmted + "</p>");
                        };
                    window.calcPos = calcPos; // TEMPORARY
                    window.curTouch = null; // TEMPORARY. MAKE VIABLE SOLUTION.
                    docEvent("touchmove", function (event) {
                        var xy = calcPos(event);
                        if (curTouch !== null) {
                            curTouch.x = xy.x;
                            curTouch.y = xy.y;
                        }
                        updateCurTouch();
                    });
                    docEvent("touchstart", function (event) {
                        var now = Date.now(), xy = calcPos(event);
                        curTouch = {
                            "t0": now,
                            "id": touchesCount,
                            "x0": xy.x,
                            "y0": xy.y,
                            "x":  xy.x,
                            "y":  xy.y
                        };
                        touchesCount += 1;
                        updateCurTouch();
                    });
                    docEvent("touchend", function () {
                        if (typeof handleTouchend !== "undefined") {
                            handleTouchend(curTouch);
                        }
                        curTouch = null;
                        updateCurTouch();
                    });
                }());
            }());
        </script>
        <script>
            playGame();
        </script>
    </body>
</html>